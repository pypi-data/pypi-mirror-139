var H=Object.defineProperty;var F=(d,t,e)=>t in d?H(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var v=(d,t,e)=>(F(d,typeof t!="symbol"?t+"":t,e),e);import{aF as X,u as Y,G as R,v as b,P as E,O as D,aG as U,o as C,c as S,d as j,$ as J,A as K,y as Q,z as Z,aH as ee,a7 as te,p as se,b as ne}from"./vendor.d790ce30.js";import{_ as ie}from"./index.ca42c5fd.js";const B=Math.cos,L=Math.max,$=Math.sin,V=Math.sqrt,oe=Math.pow,W=Math.floor,ae=Math.ceil,f=Math.PI,z=d=>oe(d,2);function O(d){return Array.from(d).filter(([,t])=>t.nodes.size==0)}function re(d){var e;return(e=O(d)[0])==null?void 0:e[0]}class ve{constructor(){v(this,"_id","id");v(this,"_dependencies","upstream_ids");v(this,"nodes",new Map);v(this,"positions",new Map);v(this,"links",[]);v(this,"rings",new Map);v(this,"expandedRings",[]);v(this,"baseRadius",500);v(this,"channelWidth",250);v(this,"width",275);v(this,"height",145);v(this,"cx",0);v(this,"cy",0);return this}center([t,e]){return this.cx=t,this.cy=e,this}expandRing(t){if(!this.rings.get(t))throw new Error("Invalid ringId when expanding ring.");if(this.expandedRings.includes(t))throw new Error("Attempted to expand an already expanded ring.");return this.expandedRings.push(t),this.computeRings(),this.computeInitialPositions(),this}collapseRing(t){if(!this.rings.get(t))throw new Error("Invalid ringId when collapsing ring.");const s=this.expandedRings.indexOf(t);if(s==-1)throw new Error("Attempted to collapse an already collapsed ring.");return this.expandedRings.splice(s,1),this.computeRings(),this.computeInitialPositions(),this}id(t){return this._id=t,this}dependencies(t){return this._dependencies=t,this}items(t){return this.update(t),this}traverse(t,e){if(!t)throw new Error("No starting node was provided to the traverse method.");const s=[t];let n;const o=new Map;for(;s.length>0;)if(n=s.shift(),e==null||e(n),!!n.downstreamNodes.size)for(const[i,r]of n.downstreamNodes)s.push(r),o.set(i,n);return o}update(t){this.nodes=new Map,this.rings=new Map,this.links=[],this.computeNodes(t),this.computeLinks(),this.computeNodeRings(),this.computeRings(),this.computeInitialPositions()}computeNodes(t){const e=t.length;for(let s=0;s<e;s++){const n=t[s],o=this.nodes.get(n[this._id]);o?this.nodes.set(n[this._id],{id:n[this._id],cx:o.cx,cy:o.cy,radian:o.radian,data:n,downstreamNodes:new Map,upstreamNodes:new Map,ring:o.ring}):this.nodes.set(n[this._id],{id:n[this._id],cx:0,cy:0,radian:0,data:n,downstreamNodes:new Map,upstreamNodes:new Map,ring:0})}}computeNodeRings(){const t=[...this.rings.entries()];for(const[e,s]of this.nodes){const n=this.distance(s,"up");s.ring=n,this.nodes.set(e,s),t[n]?t[n][1].nodes.set(e,s):t[n]=[n,{radius:0,nodes:new Map([[e,s]]),positions:new Map,links:[]}]}this.rings=new Map(t)}computeLinks(){for(const[t,e]of this.nodes){const s=e.data[this._dependencies],n=s.length;for(let o=0;o<n;o++){const i=this.nodes.get(s[o][this._id]),r={target:e,source:i};e.upstreamNodes.set(s[o][this._id],i),i.downstreamNodes.set(t,e),this.nodes.set(s[o][this._id],i),this.nodes.set(t,e),this.links.push(r)}}}distance(t,e){const s=e=="up"?"upstreamNodes":e=="down"?"downstreamNodes":void 0;if(s==null)throw new Error("Direction wasn't provided; accepted values: 'up' or 'down'.");const n=(o,i=0)=>{if(o[s].size>0){const r=[];i=i+1;for(const[,l]of o[s]){const h=n(l,i);r.push(h)}return L(...r)}return i};return n(t)}computeRings(t=0){var s;const e=[...this.rings.entries()];for(let n=t;n<e.length;n++){const o=e[0][1].nodes.size,i=e[n][1].nodes.size,r=(s=e[n-1])==null?void 0:s[1];let l;if(r?l=r.radius+this.baseRadius:l=o===1?n*this.baseRadius:(n+1)*this.baseRadius,this.expandedRings.includes(n)&&i>1){const m=V(z(this.height)+z(this.width));l=L(ae(i*m/(f*2)),l)}const h=this.computeRingPositions(l);e[n][1].radius=l,e[n][1].positions=h;for(let m=0;m<h.size;m++){const p=h.get(m);!p||this.positions.set(p.id,p)}}this.rings=new Map(e),this.links.forEach(n=>{const o=this.rings.get(n.source.ring);o&&(o.links.push(n),this.rings.set(n.source.ring,o))})}computeInitialPositions(){if(this.rings.size===0)return;let t;for(const[e,s]of this.rings){let n=0;for(const[o,i]of s.nodes){const r=this.getNodePosition(i,e,t,n);i.cx=this.cx+s.radius*B(r.radian),i.cy=this.cy+s.radius*$(r.radian),i.radian=r.radian,i.position=r,r.nodes.set(i.id,i),s.positions.set(r.id,r),this.rings.set(e,s),this.nodes.set(o,i),++n}t=s}this.nodes=new Map([...this.nodes].sort(([,e],[,s])=>!e.position||!s.position?0:e.ring==s.ring?e.position.id-s.position.id:e.ring-s.ring))}computeRingPositions(t){const e=new Map;if(t<=0)return e.set(0,{id:0,radian:0,nodes:new Map,radius:t}),e;let s=0,n=0;const o=[0],i=f/2-this.width*.8/2/t;for(;s<i;){const r=1.25-.3*$(s),l=V(z(this.height)*z(B(n))+z(this.width)*z($(n))),h=r*l/t;n+=h,s+=h,s<i&&(s<t/(this.channelWidth+this.width/2)&&(o.push(s%(2*f)),o.push((3*f-s)%(2*f))),o.push((f+s)%(2*f)),o.push((2*f-s)%(2*f)))}return o.push(f),o.sort().forEach((r,l)=>e.set(l,{id:l,radian:r,nodes:new Map,radius:t})),e}getNodePosition(t,e,s,n=0){var h,m;const i=this.rings.get(e).positions;let r;if([...i.values()].every(p=>p.nodes.size>0))return i.get(i.size-1);if(t.upstreamNodes.size===0||e==0||e==1){const p=O(i);n===0||n%2==0?r=i.get((h=p[0])==null?void 0:h[0]):r=i.get((m=p[W(p.length/2)])==null?void 0:m[0])}else{const p=t.upstreamNodes.entries();for(;!r;){const[,x]=p.next().value||[null,null];if(!x)break;const g=W(x.position/s.positions.size*i.size),y=i.get(g);if(y&&y.nodes.size===0){r=y;break}let _=g-1==0?i.size-1:g-1,M=g+1;for(;_>=0||M<=i.size;){const N=i.get(_);if(N&&N.nodes.size===0){r=N;break}const I=i.get(M);if(I&&I.nodes.size===0){r=I;break}_--,M++}}}if(!r){const p=re(i);r=typeof p!="undefined"?i.get(p):i.get(i.size-1)}return r}}const T=d=>{const t=d.radius,e=100,s=100,n=X();return n.arc(e,s,t,d.start,d.end,!1),n.toString()},de=([,d],t)=>{var h,m,p,x,g;const e=[],s=d.radius,o=125*360/(2*f*s||10),i=(90-o)*f/180,r=(90+o)*f/180;let l=((h=d.positions.get(d.positions.size-1))==null?void 0:h.radian)||0;for(const[,y]of d.positions){const _=[...y.nodes.values()],M=(g=(x=(p=(m=_==null?void 0:_[0])==null?void 0:m.data)==null?void 0:p.state)==null?void 0:x.type)==null?void 0:g.toLowerCase();s==0?e.push({start:115*f/180,end:65*f/180,radius:t/4,state:M||null}):y.radian>i&&l<r?(e.push({start:l,end:i,radius:s,state:null}),e.push({start:r,end:y.radian,radius:s,state:M||null})):e.push({start:l,end:y.radian,radius:s,state:M||null}),l=y.radian}return e};const ce=d=>(se("data-v-0a65705e"),d=d(),ne(),d),le=ce(()=>j("g",{class:"mini-radar__ring-container"},null,-1)),ue=[le],pe=Y({props:{radar:{type:null,required:!0},collapsedTrees:{type:Map,required:!1},transform:{type:Object,required:!1,default:()=>({x:0,y:0,k:1})},height:{type:Number,required:!1},width:{type:Number,required:!1},id:{type:String,required:!0},baseRadius:{type:Number,required:!1,default:300},disableInteractions:{type:Boolean,required:!1,default:!1},hideViewport:{type:Boolean,required:!1,default:!1}},emits:["drag-viewport","pan-to-location"],setup(d,{emit:t}){const e=d,s=R(),n=R(),o=R(),i=R(),r=R(0),l=R(0),h=R(!1),m=b(()=>{var c;const u=[...((c=e.collapsedTrees)==null?void 0:c.entries())||new Map().entries()];return new Map([...e.radar.nodes.entries()].filter(([,a])=>u.every(([,w])=>!w.get(a.id))).filter(([,a])=>{var A;if(!e.radar.rings.get(a.ring))return;const P=a.position;if(!P)return;const k=[...P.nodes.values()];return((A=k==null?void 0:k[0])==null?void 0:A.id)==a.id}))}),p=b(()=>{const u=new Set([...m.value.entries()].map(([,c])=>c.ring));return new Map([...e.radar.rings.entries()].filter(([c])=>u.has(c)))}),x=b(()=>{const u=[...p.value.entries()].map(([,c])=>c.radius);return Math.max(...u,e.baseRadius*2)}),g=b(()=>Math.min(l.value,r.value)/(x.value*2.5)),y=b(()=>({height:_.value.height+"px",width:_.value.width+"px"})),_=b(()=>!e.height||!e.width?{height:0,width:0}:{height:e.height*g.value,width:e.width*g.value}),M=()=>{var c;const u=a=>`radar__arc-segment ${a.state?`${a.state}-stroke`:""}`;(c=i.value)==null||c.style("transform",`scale(${g.value})`).selectAll(".radar__arc-segment-group").data(p.value).join(a=>a.append("g").attr("class","radar__arc-segment-group"),a=>a,a=>a.remove()).selectAll(".radar__arc-segment").data(a=>de(a,e.baseRadius)).join(a=>a.append("path").attr("class",u).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.1)").attr("stroke-width",80).attr("d",w=>T(w)),a=>a.attr("class",u).attr("d",w=>T(w)),a=>a.remove())},N=u=>{if(!h.value||e.disableInteractions)return;const c=u.movementX*-(1/g.value),a=u.movementY*-(1/g.value);t("drag-viewport",{x:c,y:a})},I=u=>{var k;if(e.disableInteractions)return;const c=(k=u.target)==null?void 0:k.getBoundingClientRect(),a=(u.clientX-c.left-100)/g.value,w=(u.clientY-c.top-100)/g.value,P=ee.scale(e.transform.k).translate(-a,-w);t("pan-to-location",P)},q=()=>{var a;if(!s.value)return;const u=s.value.offsetWidth,c=s.value.offsetHeight;l.value=u,r.value=c,(a=o.value)==null||a.attr("viewbox","0, 0, 200, 200").attr("width",u).attr("height",c),M()};E(()=>e.transform,()=>{if(n.value){const u=(1-e.transform.x/e.transform.k)*g.value+100-_.value.width/2,c=(1-e.transform.y/e.transform.k)*g.value+100-_.value.height/2;n.value.style.transform=`translate(${u}px, ${c}px) scale(${1/e.transform.k})`,n.value.style.borderRadius=`${Math.max(4*e.transform.k,4)}px`}}),E(p,()=>requestAnimationFrame(()=>M()));const G=()=>{o.value=te(".mini-radar__canvas"),i.value=o.value.select(".mini-radar__ring-container"),i.value.style("transform",`scale(${g.value})`),q(),M()};return D(()=>{G(),window.addEventListener("resize",q)}),U(()=>{window.removeEventListener("resize",q)}),(u,c)=>(C(),S("div",{ref:(a,w)=>{w.container=a,s.value=a},class:Z(["mini-radar position-relative",{"mini-radar--disabled":e.disableInteractions}]),onMousemove:N,onMouseleave:c[2]||(c[2]=a=>h.value=!1)},[j("svg",{class:"mini-radar__canvas",onClick:I},ue),d.hideViewport?Q("",!0):(C(),S("div",{key:0,ref:(a,w)=>{w.viewport=a,n.value=a},class:"mini-radar__viewport position-absolute",style:J(K(y)),onMousedown:c[0]||(c[0]=a=>h.value=!0),onMouseup:c[1]||(c[1]=a=>h.value=!1)},null,36))],34))}});var me=ie(pe,[["__scopeId","data-v-0a65705e"]]);export{me as M,ve as R,V as a,oe as b,B as c,f as p,$ as s};
