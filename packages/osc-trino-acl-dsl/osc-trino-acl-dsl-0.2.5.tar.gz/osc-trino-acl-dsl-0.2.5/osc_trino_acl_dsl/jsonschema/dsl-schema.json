{
    "$schema": "http://json-schema.org/draft-07/schema#",

    "$id": "https://raw.githubusercontent.com/os-climate/osc-trino-acl-dsl/main/schema/dsl-schema.json",

    "title": "Trino ACL DSL",

    "description": "A DSL for generating rules.json files for Trino",
    "type": "object",
    "properties": {
        "admin-groups": { "$ref": "#/definitions/group-array" },
        "public-tables": { "type": "boolean" },
        "catalogs": {
            "type": "array",
            "items": { "$ref": "#/definitions/catalog-entry" }
        },
        "schemas": {
            "type": "array",
            "items": { "$ref": "#/definitions/schema-entry" }
        },
        "tables": {
            "type": "array",
            "items": { "$ref": "#/definitions/table-entry" }
        }
    },
    "required": ["admin-groups", "public-tables", "catalogs", "schemas", "tables"],

    "definitions": {
        "catalog-entry": {
            "description": "an entry decribing the policy for a catalog",
            "type": "object",
            "properties": {
                "catalog": { "$ref": "#/definitions/trino-id" },
                "admin-groups": { "$ref": "#/definitions/group-array" },
                "public-tables": { "type": "boolean" }
            },
            "required": ["catalog", "admin-groups", "public-tables"]
        },
        "schema-entry": {
            "description": "an entry decribing the policy for a database schema",
            "type": "object",
            "properties": {
                "catalog": { "$ref": "#/definitions/trino-id" },
                "schema": { "$ref": "#/definitions/trino-id" },
                "admin-groups": { "$ref": "#/definitions/group-array" },
                "public-tables": { "type": "boolean" }
            },
            "required": ["catalog", "schema", "admin-groups", "public-tables"]
        },
        "table-entry": {
            "description": "an entry decribing the policy for a table",
            "type": "object",
            "properties": {
                "catalog": { "$ref": "#/definitions/trino-id" },
                "schema": { "$ref": "#/definitions/trino-id" },
                "table": { "$ref": "#/definitions/trino-id" },
                "admin-groups": { "$ref": "#/definitions/group-array" },
                "public": { "type": "boolean" },
                "column-acl": {
                    "type": "array",
                    "items": { "$ref": "#/definitions/hide-column-entry" },
                    "minItems": 1
                },
                "row-acl": { "anyOf": [
                    { "$ref": "#/definitions/row-acl-filter" }
                ]}
            },
            "required": ["catalog", "schema", "table", "admin-groups", "public"]
        },
        "group-array": {
            "description": "an array of group patterns",
            "type": "array",
            "items": { "$ref": "#/definitions/trino-id-regex" },
            "minItems": 1
        },
        "hide-column-entry": {
            "description": "an entry in the cumulative column-hiding array for column-level ACL",
            "type": "object",
            "properties": {
                "groups": { "$ref": "#/definitions/group-array" },
                "hide-columns": {
                    "type": "array",
                    "items": { "$ref": "#/definitions/trino-id" }
                }
            },
            "required": ["hide-columns"]
        },
        "row-acl-filter": {
            "description": "A row ACL spec that specifies a raw SQL filter clause",
            "type": "object",
            "properties": {
                "type": { "const": "filter" },
                "filter": { "$ref": "#/definitions/trino-sql-clause" }
            },
            "required": ["type", "filter"]
        },
        "trino-sql-clause": {
            "description": "Contains a Trino SQL clause (e.g. the argument to WHERE <clause>). TODO: it would be nice to check this for correct syntax but I am dubious it is feasible",
            "type": "string"
        },
        "trino-id": {
            "description": "a valid trino identifier, e.g. catalog, schema, or table name",
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$"
        },
        "trino-id-regex": {
            "description": "a trino id, or regex to match some id(s). TODO: define pattern",
            "type": "string"
        }
    }
}
